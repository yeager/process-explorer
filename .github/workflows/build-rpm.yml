name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: dnf install -y rpm-build python3 gettext findutils tar gzip

      - name: Get version
        id: version
        run: |
          VER=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Build RPM
        run: |
          PKG="process-explorer"
          VER="${{ steps.version.outputs.version }}"

          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          tar czf ~/rpmbuild/SOURCES/${PKG}-${VER}.tar.gz \
            --transform "s,^,${PKG}-${VER}/," \
            $(ls -d src/process_explorer process_explorer po data pyproject.toml *.desktop *.metainfo.xml 2>/dev/null)

          echo "TmFtZTogICAgICAgICAgIHByb2Nlc3MtZXhwbG9yZXIKVmVyc2lvbjogICAgICAgIFZFUlNJT05QTEFDRUhPTERFUgpSZWxlYXNlOiAgICAgICAgMQpTdW1tYXJ5OiAgICAgICAgU3lzdGVtIHByb2Nlc3MgZXhwbG9yZXIKTGljZW5zZTogICAgICAgIEdQTC0zLjAKVVJMOiAgICAgICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS95ZWFnZXIvcHJvY2Vzcy1leHBsb3JlcgpTb3VyY2UwOiAgICAgICAgJXtuYW1lfS0le3ZlcnNpb259LnRhci5negpCdWlsZEFyY2g6ICAgICAgbm9hcmNoClJlcXVpcmVzOiAgICAgICBweXRob24zID49IDMuOQpSZXF1aXJlczogICAgICAgZ3RrNApSZXF1aXJlczogICAgICAgbGliYWR3YWl0YQoKJWRlc2NyaXB0aW9uClN5c3RlbSBwcm9jZXNzIGV4cGxvcmVyCgolcHJlcAolc2V0dXAgLXEKCiVpbnN0YWxsClBZTkFNRT0icHJvY2Vzc19leHBsb3JlciIKbWtkaXIgLXAgJXtidWlsZHJvb3R9L3Vzci9saWIvcHl0aG9uMy9kaXN0LXBhY2thZ2VzLyRQWU5BTUUKaWYgWyAtZCAic3JjLyRQWU5BTUUiIF07IHRoZW4KICBjcCAtciBzcmMvJFBZTkFNRS8qICV7YnVpbGRyb290fS91c3IvbGliL3B5dGhvbjMvZGlzdC1wYWNrYWdlcy8kUFlOQU1FLwplbGlmIFsgLWQgIiRQWU5BTUUiIF07IHRoZW4KICBjcCAtciAkUFlOQU1FLyogJXtidWlsZHJvb3R9L3Vzci9saWIvcHl0aG9uMy9kaXN0LXBhY2thZ2VzLyRQWU5BTUUvCmZpCgpta2RpciAtcCAle2J1aWxkcm9vdH0vdXNyL2JpbgpjYXQgPiAle2J1aWxkcm9vdH0vdXNyL2Jpbi8le25hbWV9IDw8ICdMQVVOQ0hFUicKIyEvdXNyL2Jpbi9weXRob24zCmltcG9ydCBzeXMKZnJvbSBwcm9jZXNzX2V4cGxvcmVyLm1haW4gaW1wb3J0IG1haW4Kc3lzLmV4aXQobWFpbigpKQpMQVVOQ0hFUgpjaG1vZCA3NTUgJXtidWlsZHJvb3R9L3Vzci9iaW4vJXtuYW1lfQoKbWtkaXIgLXAgJXtidWlsZHJvb3R9L3Vzci9zaGFyZS9hcHBsaWNhdGlvbnMKbWtkaXIgLXAgJXtidWlsZHJvb3R9L3Vzci9zaGFyZS9tZXRhaW5mbwpta2RpciAtcCAle2J1aWxkcm9vdH0vdXNyL3NoYXJlL2ljb25zL2hpY29sb3Ivc2NhbGFibGUvYXBwcwpmb3IgZiBpbiBkYXRhLyouZGVza3RvcCAqLmRlc2t0b3A7IGRvCiAgWyAtZiAiJGYiIF0gJiYgaW5zdGFsbCAtbSA2NDQgIiRmIiAle2J1aWxkcm9vdH0vdXNyL3NoYXJlL2FwcGxpY2F0aW9ucy8KZG9uZQpmb3IgZiBpbiBkYXRhLyoubWV0YWluZm8ueG1sICoubWV0YWluZm8ueG1sOyBkbwogIFsgLWYgIiRmIiBdICYmIGluc3RhbGwgLW0gNjQ0ICIkZiIgJXtidWlsZHJvb3R9L3Vzci9zaGFyZS9tZXRhaW5mby8KZG9uZQpmaW5kIGRhdGEvaWNvbnMgLW5hbWUgIiouc3ZnIiAtcHJpbnQwIDI+L2Rldi9udWxsIHwgeGFyZ3MgLTAgLUl7fSBpbnN0YWxsIC1tIDY0NCB7fSAle2J1aWxkcm9vdH0vdXNyL3NoYXJlL2ljb25zL2hpY29sb3Ivc2NhbGFibGUvYXBwcy8gMj4vZGV2L251bGwgfHwgdHJ1ZQoKZm9yIHBvIGluIHBvLyoucG87IGRvCiAgWyAtZiAiJHBvIiBdIHx8IGNvbnRpbnVlCiAgbGFuZz0kKGJhc2VuYW1lICIkcG8iIC5wbykKICBta2RpciAtcCAle2J1aWxkcm9vdH0vdXNyL3NoYXJlLyV7bmFtZX0vbG9jYWxlLyRsYW5nL0xDX01FU1NBR0VTCiAgbXNnZm10IC1vICV7YnVpbGRyb290fS91c3Ivc2hhcmUvJXtuYW1lfS9sb2NhbGUvJGxhbmcvTENfTUVTU0FHRVMvJXtuYW1lfS5tbyAiJHBvIgpkb25lCgolZmlsZXMKL3Vzci9iaW4vJXtuYW1lfQovdXNyL2xpYi9weXRob24zL2Rpc3QtcGFja2FnZXMvcHJvY2Vzc19leHBsb3Jlci8KL3Vzci9zaGFyZS9hcHBsaWNhdGlvbnMvCi91c3Ivc2hhcmUvbWV0YWluZm8vCi91c3Ivc2hhcmUvaWNvbnMvCi91c3Ivc2hhcmUvJXtuYW1lfS8K" | base64 -d | sed "s/VERSIONPLACEHOLDER/$VER/" > ~/rpmbuild/SPECS/${PKG}.spec

          rpmbuild -bb ~/rpmbuild/SPECS/${PKG}.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload RPM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER="${{ steps.version.outputs.version }}"
          RPM=$(ls *.rpm | head -1)
          gh release upload "v${VER}" "$RPM" --clobber 2>/dev/null || \
          gh release upload "${{ github.ref_name }}" "$RPM" --clobber 2>/dev/null || true
